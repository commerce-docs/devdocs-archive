<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>Magento_Sales module | Archived Magento 2.1 Developer Documentation</title>
	<meta name="description" content="Archived Magento 2.1.18 Developer Documentation.">

	<link rel="stylesheet" href="/devdocs-archive/2.1/assets/css/app.css" />
	<link rel="stylesheet" href="/devdocs-archive/2.1/assets/css/print.css" media="print"/>

	<link rel="stylesheet" href="/devdocs-archive/2.1/common/css/devdocs.css" />
<link rel="alternate" type="application/rss+xml" title="Magento DevDocs RSS" href="/feed.xml" />



	<script>
  var baseUrl = "/devdocs-archive/2.1";
  var algolia = {
    id : "",
    index:  "",
    key:  "",
    facetFilters: [["guide_version: 2.1", "versionless: true"]]
  };
</script>




	<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="https://magento.com/favicon.ico">
	<link rel="apple-touch-icon" type="image/png" href="https://magento.com/apple-touch-icon.png">
	<link rel="apple-touch-icon" type="image/png" sizes="57x57" href="https://magento.com/apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" type="image/png" sizes="72x72" href="https://magento.com/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://magento.com/apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" type="image/png" sizes="114x114" href="https://magento.com/apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://magento.com/apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" type="image/png" sizes="144x144" href="https://magento.com/apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://magento.com/apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://magento.com/apple-touch-icon-180x180.png">

</head>
<body class="layout-default">

	<header class="site-header">

		<nav class="site-nav">

  <div class="menu-btn">
    <button id="menu-btn" class="menu-trigger menu-icon" aria-haspopup="true" aria-controls="nav-main" aria-label="Menu"></button>
  </div>

  <div class="nav-container">

    <a class="logo" href="/devdocs-archive/2.1/">
      <img src="/devdocs-archive/2.1/assets/i/m-logo.svg" alt=""><img src="/devdocs-archive/2.1/assets/i/magento-logo.svg" alt="Magento" class="magento-logo" />
      <span class="site-logo">DevDocs</span>
    </a>

    <div id="nav-main" class="nav-main-wrap" aria-labelledby="menu-btn">
      


<div class="version-switcher dropdown">
	<button class="btn dropdown-toggle" disabled>
		Magento 2.1
	</button>
</div>


      <!-- Main Navigation --><ul class="nav-main" role="menubar"><li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Cloud</span><div class="nav-popup"><div class="nav-section">
              <div class="nav-section-title">Cloud basics</div>
              <ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/cloud/bk-cloud.html">Cloud Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/cloud/architecture/cloud-architecture.html">Cloud Architecture</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/cloud/project/project-upgrade-parent.html">Upgrades and Patches</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/cloud/release-notes/cloud-tools.html">Release Notes</a></li></ul>
            </div><div class="nav-section">
              <div class="nav-section-title">Cloud development</div>
              <ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/cloud/setup/first-time-setup.html">Local development</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/cloud/docker/docker-config.html">Launch Docker</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/cloud/docker/docker-quick-reference.html">Docker quick reference</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/cloud/env/environments.html">Configure Environments</a></li></ul>
            </div></div></li><li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Setup</span><div class="nav-popup"><ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/install-gde/bk-install-guide.html">Installation Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/extensions/">Magento Extensions Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/comp-mgr/bk-compman-upgrade-guide.html">Component Manager and System Upgrade Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/config-guide/bk-config-guide.html">Configuration Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/migration/bk-migration-guide.html">Migration Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/release-notes/bk-release-notes.html">Release Information</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/reference/cli/magento.html">Command-line Tools Reference</a></li></ul></div></li><li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Development</span><div class="nav-popup"><div class="nav-section">
              <div class="nav-section-title">Backend</div>
              <ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/architecture/bk-architecture.html">Architecture</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/extension-dev-guide/bk-extension-dev-guide.html">PHP Developer Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/ext-best-practices/bk-ext-best-practices.html">Extension Developer Best Practices</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/intro.html">Module Reference Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/coding-standards/bk-coding-standards.html">Coding Standards</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/contributor-guide/contributing.html">Contributor Guide</a></li></ul>
            </div><div class="nav-section">
              <div class="nav-section-title">Frontend</div>
              <ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/frontend-dev-guide/bk-frontend-dev-guide.html">Frontend Developer Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/ui_comp_guide/bk-ui_comps.html">UI Components Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/javascript-dev-guide/bk-javascript-dev-guide.html">JavaScript Developer Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/pattern-library/bk-pattern.html">Admin Design Pattern Library</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/design-styleguide/bk-styleguide.html">Admin Style Guide</a></li></ul>
            </div><div class="nav-section">
              <div class="nav-section-title">API</div>
              <ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/get-started/bk-get-started-api.html">Get Started with Magento Web APIs</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/rest/bk-rest.html">REST API Reference</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/soap/bk-soap.html">SOAP API Reference</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/marketplace/eqp/api.html">Marketplace EQP API Reference</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/mbi/docs/getting-started.html">Business Intelligence Import API</a></li></ul>
            </div></div></li><li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Testing</span><div class="nav-popup"><ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/test/testing.html">Magento Testing Guide</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mtf/mtf_introduction.html">Functional Testing</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/test/integration/integration_test_execution.html">Integration Testing</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/test/js/jasmine.html">JavaScript Unit Testing</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/test/unit/unit_test_execution.html">PHP Unit Testing</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/get-started/web-api-functional-testing.html">Web API Functional Testing</a></li></ul></div></li><li class="nav-main-separator"></li><li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Functional Areas</span><div class="nav-popup"><ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/howdoi/checkout/checkout_overview.html">Checkout</a></li><li class="" role="menuitem"><a href="http://omsdocs.magento.com/en/">Order Management</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/payments-integrations/bk-payments-integrations.html">Payment Integrations</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/extension-dev-guide/staging.html">Staging</a></li></ul></div></li><li class="nav-main-item" tabindex="0" role="menuitem" aria-haspopup="true">
    <span tabindex="-1">Tutorials</span><div class="nav-popup"><ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/rest/tutorials/index.html">Rest Tutorials</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/howdoi/customize_product.html">Customize Product Creation Form</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/howdoi/checkout/checkout_overview.html">Customize Checkout</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/community/resources/support.html">Magento Support</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/videos/">Video Tutorials</a></li></ul></div></li></ul><!-- /.nav-main -->

    </div>

  </div>

</nav><!-- #site-nav -->
<div class="nav-main-fader"></div>


	</header>

	<div class="global-wrapper">

		
    <div class="message-banner">
       <a href="http://devdocs.magento.com/guides/v2.1/release-notes/ReleaseNotes2.1.18CE.html" target="_blank">Magento 2.1.18</a> is the final 2.1.x release. After June 2019, Magento 2.1.x will no longer receive security patches, quality fixes, or documentation updates.</br>To maintain your site's performance, security, and PCI compliance, upgrade to the latest version of Magento.</a>
    </div>









		<div class="main-container">
			<a id="main-content"></a>


<div class="content-container">

	<!-- sidebar -->
<aside class="sidebar">
	<button class="toc-toggler">Table of Contents</button>
	<div class="sidebar-wrapper">

		

		<h4 class="guide-title">Module Reference Guide</h4>
		<div class="collapsible-navigation">
		    <ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/intro.html">INTRODUCTION</a></li><li class="" role="menuitem"><span>Open Source</span><ul><li class="active" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ce/Sales.html">Sales</a></li></ul></li><li class="" role="menuitem"><span>Commerce</span><ul><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/BundleStaging.html">BundleStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/CatalogImportExportStaging.html">CatalogImportExportStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/CatalogInventoryStaging.html">CatalogInventoryStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/CatalogRuleStaging.html">CatalogRuleStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/CatalogStaging.html">CatalogStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/CatalogUrlRewriteStaging.html">CatalogUrlRewriteStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/CheckoutStaging.html">CheckoutStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/CmsStaging.html">CmsStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/ConfigurableProductStaging.html">ConfigurableProductStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/DownloadableStaging.html">DownloadableStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/GiftCardStaging.html">GiftCardStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/GiftMessageStaging.html">GiftMessageStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/GiftWrappingStaging.html">GiftWrappingStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/GoogleOptimizerStaging.html">GoogleOptimizerStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/GroupedProductStaging.html">GroupedProductStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/LayeredNavigationStaging.html">LayeredNavigationStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/MsrpStaging.html">MsrpStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/PaymentStaging.html">PaymentStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/ProductVideoStaging.html">ProductVideoStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/ReviewStaging.html">ReviewStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/RmaStaging.html">RmaStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/SalesRuleStaging.html">SalesRuleStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/SearchStaging.html">SearchStaging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/Staging.html">Staging</a></li><li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/mrg/ee/WeeeStaging.html">WeeeStaging</a></li></ul></li></ul>
		</div>

	</div>

</aside>
<!-- /sidebar -->


	<section class="content">
		<div class="content-wrap">
			<!-- page-header -->
<section class="page-intro">
	

	

	<h1 class="page-heading">Magento_Sales module</h1>
</section>

			<p>Magento_Sales <a href="https://glossary.magento.com/module">module</a> is responsible for order processing and appearance in system.</p>

<p>Magento_Sales module manages next system entities and flows:</p>

<ul>
  <li>order management</li>
  <li><a href="https://glossary.magento.com/invoice">invoice</a> management</li>
  <li><a href="https://glossary.magento.com/shipment">shipment</a> management (including track management)</li>
  <li>credit memos management</li>
</ul>

<p>Magento_Sales module is required for Magento_Checkout module to perform <a href="https://glossary.magento.com/checkout">checkout</a> operations.</p>

<h2 id="system-requirements">System requirements</h2>

<p>The Magento_Sales module does not have any specific system requirements.</p>

<p>Depending on how many orders are being placed, there might be consideration for the database size.</p>

<h2 id="installation">Installation</h2>

<p>The Magento_Sales module is installed automatically during Magento installation.</p>

<h2 id="invoiceorder">InvoiceOrder</h2>

<p>The InvoiceOrder service introduces a capability to execute Magento native business flow of the Sales <a href="https://glossary.magento.com/module">module</a> using <a href="https://glossary.magento.com/api">API</a>.</p>

<p>With this service you can:</p>

<ul>
  <li>create an <a href="https://glossary.magento.com/invoice">invoice</a> document (full or partial)</li>
  <li>capture money placed with order payment</li>
  <li>notify a customer about document creation</li>
  <li>change <a href="https://glossary.magento.com/order-status">order status</a> and state</li>
</ul>

<h3 id="parameters">Parameters</h3>

<table>
<thead>
  <tr>
    <th>Name</th>
    <th>Description</th>
    <th>Format</th>
    <th>Example</th>
    <th>Required / Optional</th>
    <th>Default value</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td><code>orderId</code></td>
    <td>An identifier of a target order for operation.</td>
    <td>Integer</td>
    <td>&nbsp;</td>
    <td>Required</td>
    <td>&nbsp;</td>
  </tr>
  <tr>
    <td><code>items</code></td>
    <td>An array of order items that will be included to invoice. By default, the invoice will contain all order items.</td>
    <td>Array of items with a format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/InvoiceItemCreationInterface.php"><code>\Magento\Sales\Api\Data\InvoiceItemCreationInterface</code></a>.</td>
    <td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"order_item_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"qty"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
  </span><span class="nl">"order_item_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"qty"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td>Optional (required, when invoice must contain particular order items.</td>
<td><code>[]</code></td>
</tr>
<tr>
<td><code>capture</code></td>
<td>Flag that sets whether the customer’s payment can be captured using an online payments system (for example, PayPal). <strong>IMPORTANT: If you created Invoice with the flag set to default value (<code>false</code>), you will not be able to capture money in Magento on the corresponding Invoice.</strong></td>
<td>Boolean</td>
<td>&nbsp;</td>
<td>Optional</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>notify</code></td>
<td>Flag that activates e-mail notification about new invoice for a customer. If <code>true</code>, the service will notify a customer. If <code>false</code>, the service won’t notify a customer.</td>
<td>Boolean</td>
<td>&nbsp;</td>
<td>Optional</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>appendComment</code></td>
<td>Flag that determines whether a <code>comment</code> argument must be included in an e-mail notification. If <code>true</code>, the service adds the comment.</td>
<td>Boolean</td>
<td>&nbsp;</td>
<td>Optional</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>comment</code></td>
<td>The comment to add to an invoice. Specify a comment if <code>appendComment</code> is set to <code>true</code>.</td>
<td>A format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/InvoiceCommentCreationInterface.php"><code>\Magento\Sales\Api\Data\InvoiceCommentCreationInterface</code></a>.</td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"comment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The first Invoice"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"is_visible_on_front"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td>Optional</td>
<td><code>null</code></td>
</tr>
<tr>
<td><code>arguments</code></td>
<td>Additional arguments. Reserved for use by extension modules.</td>
<td>A format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/InvoiceCreationArgumentsInterface.php"><code>\Magento\Sales\Api\Data\InvoiceCreationArgumentsInterface</code></a>.</td>
<td>&nbsp;</td>
<td>Optional</td>
<td><code>null</code></td>
</tr>
</tbody>
</table>

<h3 id="return-values">Return values</h3>

<p>The service returns an identifier of the created Invoice.</p>

<h3 id="rest">REST</h3>

<h4 id="post-endpoint">POST Endpoint</h4>

<p><code class="highlighter-rouge">http://&lt;magento_host&gt;/rest/&lt;store_code&gt;/V1/&lt;orderId&gt;/invoice</code></p>

<h4 id="rest-declaration">REST declaration</h4>

<p><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/etc/webapi.xml"><code class="highlighter-rouge">etc/webapi.xml</code></a></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;route</span> <span class="na">url=</span><span class="s">"/V1/order/:orderId/invoice"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">class=</span><span class="s">"Magento\Sales\Api\InvoiceOrderInterface"</span> <span class="na">method=</span><span class="s">"execute"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;resources&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">ref=</span><span class="s">"Magento_Sales::sales"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resources&gt;</span>
<span class="nt">&lt;/route&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="soap">SOAP</h3>

<h4 id="soap-endpoint">SOAP Endpoint</h4>

<p><code class="highlighter-rouge">http://&lt;magento_host&gt;/soap/&lt;store_code&gt;?wsdl&amp;services=salesInvoiceOrderV1</code></p>

<h3 id="php-interface">PHP interface</h3>

<p><code class="highlighter-rouge">\Magento\Sales\Api\InvoiceOrderInterface</code></p>

<div class="collapsible">
    <b class="collapsible-title">Click to show/hide a code </b>
    <div class="collapsible-content"><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cd">/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */</span>

<span class="kn">namespace</span> <span class="nn">Magento\Sales\Api</span><span class="p">;</span>

<span class="cd">/**
 * Class InvoiceOrderInterface
 *
 * @api
 */</span>
<span class="kd">interface</span> <span class="nc">InvoiceOrderInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * @param int $orderId
     * @param bool|false $capture
     * @param \Magento\Sales\Api\Data\InvoiceItemCreationInterface[] $items
     * @param bool|false $notify
     * @param bool|false $appendComment
     * @param Data\InvoiceCommentCreationInterface|null $comment
     * @param Data\InvoiceCreationArgumentsInterface|null $arguments
     * @return int
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="nv">$capture</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="kt">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\InvoiceCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\InvoiceCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">);</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
</div>
  </div>

<h3 id="php-implementation">PHP implementation</h3>

<p><code class="highlighter-rouge">\Magento\Sales\Model\InvoiceOrder</code></p>

<div class="collapsible">
    <b class="collapsible-title">Click to show/hide included code </b>
    <div class="collapsible-content"><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cd">/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */</span>

<span class="kn">namespace</span> <span class="nn">Magento\Sales\Model</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Magento\Framework\App\ResourceConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\Data\InvoiceCommentCreationInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\Data\InvoiceCreationArgumentsInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\InvoiceOrderInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\OrderRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Config</span> <span class="k">as</span> <span class="nc">OrderConfig</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Invoice\InvoiceValidatorInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Invoice\NotifierInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\InvoiceDocumentFactory</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\InvoiceRepository</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\OrderStateResolverInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\OrderValidatorInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\PaymentAdapterInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Validation\InvoiceOrderInterface</span> <span class="k">as</span> <span class="nc">InvoiceOrderValidator</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Psr\Log\LoggerInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Framework\App\ObjectManager</span><span class="p">;</span>

<span class="cd">/**
 * Class InvoiceOrder
 * @SuppressWarnings(PHPMD.CouplingBetweenObjects)
 */</span>
<span class="kd">class</span> <span class="nc">InvoiceOrder</span> <span class="kd">implements</span> <span class="nc">InvoiceOrderInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var ResourceConnection
     */</span>
    <span class="k">private</span> <span class="nv">$resourceConnection</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderRepositoryInterface
     */</span>
    <span class="k">private</span> <span class="nv">$orderRepository</span><span class="p">;</span>

    <span class="cd">/**
     * @var InvoiceDocumentFactory
     */</span>
    <span class="k">private</span> <span class="nv">$invoiceDocumentFactory</span><span class="p">;</span>

    <span class="cd">/**
     * @var PaymentAdapterInterface
     */</span>
    <span class="k">private</span> <span class="nv">$paymentAdapter</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderStateResolverInterface
     */</span>
    <span class="k">private</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderConfig
     */</span>
    <span class="k">private</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="cd">/**
     * @var InvoiceRepository
     */</span>
    <span class="k">private</span> <span class="nv">$invoiceRepository</span><span class="p">;</span>

    <span class="cd">/**
     * @var InvoiceOrderValidator
     */</span>
    <span class="k">private</span> <span class="nv">$invoiceOrderValidator</span><span class="p">;</span>

    <span class="cd">/**
     * @var NotifierInterface
     */</span>
    <span class="k">private</span> <span class="nv">$notifierInterface</span><span class="p">;</span>

    <span class="cd">/**
     * @var LoggerInterface
     */</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="cd">/**
     * InvoiceOrder constructor.
     * @param ResourceConnection $resourceConnection
     * @param OrderRepositoryInterface $orderRepository
     * @param InvoiceDocumentFactory $invoiceDocumentFactory
     * @param InvoiceValidatorInterface $invoiceValidator
     * @param OrderValidatorInterface $orderValidator
     * @param PaymentAdapterInterface $paymentAdapter
     * @param OrderStateResolverInterface $orderStateResolver
     * @param OrderConfig $config
     * @param InvoiceRepository $invoiceRepository
     * @param NotifierInterface $notifierInterface
     * @param LoggerInterface $logger
     * @param InvoiceOrderValidator|null $invoiceOrderValidator
     * @SuppressWarnings(PHPMD.ExcessiveParameterList)
     * @SuppressWarnings(PHPMD.UnusedFormalParameter)
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">ResourceConnection</span> <span class="nv">$resourceConnection</span><span class="p">,</span>
        <span class="kt">OrderRepositoryInterface</span> <span class="nv">$orderRepository</span><span class="p">,</span>
        <span class="kt">InvoiceDocumentFactory</span> <span class="nv">$invoiceDocumentFactory</span><span class="p">,</span>
        <span class="kt">InvoiceValidatorInterface</span> <span class="nv">$invoiceValidator</span><span class="p">,</span>
        <span class="kt">OrderValidatorInterface</span> <span class="nv">$orderValidator</span><span class="p">,</span>
        <span class="kt">PaymentAdapterInterface</span> <span class="nv">$paymentAdapter</span><span class="p">,</span>
        <span class="kt">OrderStateResolverInterface</span> <span class="nv">$orderStateResolver</span><span class="p">,</span>
        <span class="kt">OrderConfig</span> <span class="nv">$config</span><span class="p">,</span>
        <span class="kt">InvoiceRepository</span> <span class="nv">$invoiceRepository</span><span class="p">,</span>
        <span class="kt">NotifierInterface</span> <span class="nv">$notifierInterface</span><span class="p">,</span>
        <span class="kt">LoggerInterface</span> <span class="nv">$logger</span><span class="p">,</span>
        <span class="kt">InvoiceOrderValidator</span> <span class="nv">$invoiceOrderValidator</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resourceConnection</span> <span class="o">=</span> <span class="nv">$resourceConnection</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span> <span class="o">=</span> <span class="nv">$orderRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">invoiceDocumentFactory</span> <span class="o">=</span> <span class="nv">$invoiceDocumentFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">paymentAdapter</span> <span class="o">=</span> <span class="nv">$paymentAdapter</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderStateResolver</span> <span class="o">=</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">invoiceRepository</span> <span class="o">=</span> <span class="nv">$invoiceRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notifierInterface</span> <span class="o">=</span> <span class="nv">$notifierInterface</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">invoiceOrderValidator</span> <span class="o">=</span> <span class="nv">$invoiceOrderValidator</span> <span class="o">?:</span> <span class="nc">ObjectManager</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span>
            <span class="nc">InvoiceOrderValidator</span><span class="o">::</span><span class="n">class</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @param int $orderId
     * @param bool $capture
     * @param array $items
     * @param bool $notify
     * @param bool $appendComment
     * @param \Magento\Sales\Api\Data\InvoiceCommentCreationInterface|null $comment
     * @param \Magento\Sales\Api\Data\InvoiceCreationArgumentsInterface|null $arguments
     * @return int
     * @throws \Magento\Sales\Api\Exception\DocumentValidationExceptionInterface
     * @throws \Magento\Sales\Api\Exception\CouldNotInvoiceExceptionInterface
     * @throws \Magento\Framework\Exception\InputException
     * @throws \Magento\Framework\Exception\NoSuchEntityException
     * @throws \DomainException
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="nv">$capture</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="kt">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="kt">InvoiceCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="kt">InvoiceCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resourceConnection</span><span class="o">-&gt;</span><span class="nf">getConnection</span><span class="p">(</span><span class="s1">'sales'</span><span class="p">);</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$orderId</span><span class="p">);</span>
        <span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">invoiceDocumentFactory</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="p">(</span><span class="nv">$appendComment</span> <span class="o">&amp;&amp;</span> <span class="nv">$notify</span><span class="p">),</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="nv">$errorMessages</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">invoiceOrderValidator</span><span class="o">-&gt;</span><span class="nf">validate</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$invoice</span><span class="p">,</span>
            <span class="nv">$capture</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$notify</span><span class="p">,</span>
            <span class="nv">$appendComment</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$errorMessages</span><span class="o">-&gt;</span><span class="nf">hasMessages</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Magento\Sales\Exception\DocumentValidationException</span><span class="p">(</span>
                <span class="nf">__</span><span class="p">(</span><span class="s2">"Invoice Document Validation Error(s):</span><span class="se">\n</span><span class="s2">"</span> <span class="mf">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$errorMessages</span><span class="o">-&gt;</span><span class="nf">getMessages</span><span class="p">()))</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">paymentAdapter</span><span class="o">-&gt;</span><span class="nf">pay</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$invoice</span><span class="p">,</span> <span class="nv">$capture</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setState</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderStateResolver</span><span class="o">-&gt;</span><span class="nf">getStateForOrder</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="p">[</span><span class="nc">OrderStateResolverInterface</span><span class="o">::</span><span class="no">IN_PROGRESS</span><span class="p">])</span>
            <span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setStatus</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="nf">getStateDefaultStatus</span><span class="p">(</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">getState</span><span class="p">()));</span>
            <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="nf">setState</span><span class="p">(</span><span class="err">\</span><span class="nc">Magento\Sales\Model\Order\Invoice</span><span class="o">::</span><span class="no">STATE_PAID</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">invoiceRepository</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$invoice</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="err">\</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span><span class="o">-&gt;</span><span class="nf">critical</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Magento\Sales\Exception\CouldNotInvoiceException</span><span class="p">(</span>
                <span class="nf">__</span><span class="p">(</span><span class="s1">'Could not save an invoice, see error log for details'</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$notify</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$appendComment</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notifierInterface</span><span class="o">-&gt;</span><span class="nf">notify</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$invoice</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="nf">getEntityId</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
</div>
  </div>

<h4 id="exceptions">Exceptions</h4>

<p>In case of failure, it returns an error object. Example in REST:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Creditmemo Document Validation Error(s):</span><span class="se">\n</span><span class="s2">We can't create creditmemo for the order.</span><span class="se">\n</span><span class="s2">The most money available to refund is 0."</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="extension-points">Extension points</h4>

<p>The service implementation contains <a href="https://glossary.magento.com/extension">extension</a> points marked with <code class="highlighter-rouge">@api</code> annotation. Extension developers can use APIs to extend service logic.</p>

<table>
  <thead>
    <tr>
      <th>Extension point</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/OrderRepositoryInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Api\OrderRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Orders.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/OrderStateResolverInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\OrderStateResolverInterface</code></a></td>
      <td>An interface which provides a correct state of an Order according to performed operation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/InvoiceRepositoryInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Api\InvoiceRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Shipments.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/InvoiceDocumentFactory.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\InvoiceDocumentFactory</code></a></td>
      <td>A factory for creating an Invoice data object. The factory uses the <code class="highlighter-rouge">arguments</code> parameter to process the extension attributes of a new Invoice.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Invoice/NotifierInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\Invoice\NotifierInterface</code></a></td>
      <td>An interface for sending notifications about new Invoice creation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Validation/InvoiceOrderInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\Validation\InvoiceOrderInterface</code></a></td>
      <td>An interface for validating service parameters and Invoice data object.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/PaymentAdapterInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\PaymentAdapterInterface</code></a></td>
      <td>An interface for a payment according to a selected option (online/offline). It returns Order with modified state, which contains payment specific information.</td>
    </tr>
  </tbody>
</table>

<h2 id="refundinvoice">RefundInvoice</h2>

<p>The RefundInvoice service introduces a capability to execute Magento native business flow of the Sales module using API.</p>

<p>Please note, that current service is available only for invoices created using online payment methods. If you try to apply it to an Invoice created using offline payment method, system will throw a validation error.</p>

<p>With this service you can:</p>

<ul>
  <li>create a <a href="https://glossary.magento.com/credit-memo">Credit Memo</a> (complete or partial) for particular Invoice</li>
  <li>add details about refunded items to an Order</li>
  <li>change status and state of an Order according to performed actions</li>
  <li>notify a customer about performed refund operation</li>
</ul>

<h3 id="service-parameters">Service parameters</h3>

<table>
<thead>
  <tr>
    <th>
      Name
    </th>
    <th>
      Description
    </th>
    <th>
      Format
    </th>
    <th>
      Example
    </th>
    <th>
      Required/Optional
    </th>
    <th>
      Default value
    </th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>
      <code>invoiceId</code>
    </td>
    <td>
      An identifier of a target Invoice for operation.
    </td>
    <td>
      Integer
    </td>
    <td>
      &nbsp;
    </td>
    <td>
      Required
    </td>
    <td>
      &nbsp;
    </td>
  </tr>
  <tr>
    <td>
      <code>items</code>
    </td>
    <td>
      An array of invoice items included to a Credit Memo. By
      default, the service will create a Credit Memo for all
      invoice items.
    </td>
    <td>
      Array of items with a format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoItemCreationInterface.php">
      <code>\Magento\Sales\Api\Data\CreditmemoItemCreationInterface</code></a>.
</td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
        </span><span class="nl">"order_item_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"qty"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
  </span><span class="nl">"order_item_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"qty"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td>
  Optional (required, when a Credit Memo must contain
  particular order items)
</td>
<td>
  <code>[]</code>
</td>
</tr>
<tr>
<td>
  <code>isOnline</code>
</td>
<td>
  Flag that determines whether funds should be returned to a
  customer via online payment system (PayPal for example) or
  not.
</td>
<td>
  Boolean
</td>
<td>
  &nbsp;
</td>
<td>
  Optional
</td>
<td>
  <code>false</code>
</td>
</tr>
<tr>
<td></td>
</tr>
<tr>
<td>
<code>notify</code>
</td>
<td>
  Flag that activates e-mail notification about Credit Memo
  creation. If <code>true</code>, the service notifies a
  customer; if <code>false</code>, it doesn't.
</td>
<td>
  Boolean
</td>
<td>
  &nbsp;
</td>
<td>
  Optional
</td>
<td>
  <code>false</code>
</td>
</tr>
<tr>
<td>
  <code>appendComment</code>
</td>
<td>
  Flag that activates addition of a <code>comment</code>
  argument to the e-mail notification. If <code>true</code>
  and <code>comment</code> contains data, the service will
  add the comment to an e-mail notification.
</td>
<td>
Boolean
</td>
<td>
  &nbsp;
</td>
<td>
  Optional
</td>
<td>
  <code>false</code>
</td>
</tr>
<tr>
<td>
  <code>comment</code>
</td>
<td>
  A comment to Credit Memo.
</td>
<td>
  A format according to the <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCommentCreationInterface.php">
  <code>\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</code></a>.
</td><td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
</span><span class="nl">"comment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The first Credit Memo"</span><span class="p">,</span><span class="w">
</span><span class="nl">"is_visible_on_front"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td>
  Optional
</td>
<td>
  <code>null</code>
</td>
</tr>
<tr>
<td>
  <code>arguments</code>
</td>
<td>
  Additional arguments for the service. Can be used by
  extension modules.
</td>
<td>
  A format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCreationArgumentsInterface.php">
  <code>\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</code></a>.
</td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
</span><span class="nl">"shipping_amount"</span><span class="p">:</span><span class="w"> </span><span class="mf">10.00</span><span class="p">,</span><span class="w">
</span><span class="nl">"adjustment_positive"</span><span class="p">:</span><span class="w"> </span><span class="mf">5.00</span><span class="p">,</span><span class="w">
</span><span class="nl">"adjustment_negative"</span><span class="p">:</span><span class="w"> </span><span class="mf">5.00</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

        <p>A parameter <code class="highlighter-rouge">shipping_amount</code> behaves like at the Credit Memo creation page in the Admin area. If shipping amount is not specified, then shipping amount from a target Invoice is refunded automatically. To specify a shipping amount, consider shipping tax displays settings.</p>
      </td>
<td>
Optional
</td>
<td>
<code>null</code>
</td>
</tr>
</tbody>
</table>

<h3 id="return-values-1">Return values</h3>

<p>The service returns an identifier of a created Credit Memo.</p>

<h3 id="rest-1">REST</h3>

<h4 id="post-endpoint-1">POST Endpoint</h4>

<p><code class="highlighter-rouge">http://&lt;magento_host&gt;/rest/&lt;store_code&gt;/V1/&lt;invoiceId&gt;/refund</code></p>

<h4 id="rest-declaration-1">REST Declaration</h4>

<p><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/etc/webapi.xml"><code class="highlighter-rouge">etc/webapi.xml</code></a></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;route</span> <span class="na">url=</span><span class="s">"/V1/invoice/:invoiceId/refund"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">class=</span><span class="s">"Magento\Sales\Api\RefundInvoiceInterface"</span> <span class="na">method=</span><span class="s">"execute"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;resources&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">ref=</span><span class="s">"Magento_Sales::sales"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resources&gt;</span>
<span class="nt">&lt;/route&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="soap-1">SOAP</h3>

<h4 id="soap-endpoint-1">SOAP Endpoint</h4>

<p><code class="highlighter-rouge">http://&lt;magento_host&gt;/soap/&lt;store_code&gt;?wsdl&amp;services=salesRefundInvoiceV1</code></p>

<h3 id="php-interface-1">PHP interface</h3>

<p><code class="highlighter-rouge">\Magento\Sales\Api\RefundInvoiceInterface</code></p>

<div class="collapsible">
    <b class="collapsible-title">Click to show/hide a code </b>
    <div class="collapsible-content"><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cd">/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */</span>
<span class="kn">namespace</span> <span class="nn">Magento\Sales\Api</span><span class="p">;</span>

<span class="cd">/**
 * Interface RefundInvoiceInterface
 */</span>
<span class="kd">interface</span> <span class="nc">RefundInvoiceInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * Create refund for invoice
     *
     * @param int $invoiceId
     * @param \Magento\Sales\Api\Data\CreditmemoItemCreationInterface[] $items
     * @param bool|null $isOnline
     * @param bool|null $notify
     * @param bool|null $appendComment
     * @param \Magento\Sales\Api\Data\CreditmemoCommentCreationInterface|null $comment
     * @param \Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface|null $arguments
     * @return int
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">execute</span><span class="p">(</span>
        <span class="nv">$invoiceId</span><span class="p">,</span>
        <span class="kt">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$isOnline</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">);</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
</div>
  </div>

<h3 id="php-implementation-1">PHP implementation</h3>

<p><code class="highlighter-rouge">\Magento\Sales\Model\RefundInvoice</code></p>

<div class="collapsible">
    <b class="collapsible-title">Click to show/hide a code </b>
    <div class="collapsible-content"><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cd">/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */</span>
<span class="kn">namespace</span> <span class="nn">Magento\Sales\Model</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Magento\Framework\App\ResourceConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\CreditmemoRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\InvoiceRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\OrderRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\RefundInvoiceInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Config</span> <span class="k">as</span> <span class="nc">OrderConfig</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Creditmemo\NotifierInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\CreditmemoDocumentFactory</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Validation\RefundInvoiceInterface</span> <span class="k">as</span> <span class="nc">RefundInvoiceValidator</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\OrderStateResolverInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\RefundAdapterInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Psr\Log\LoggerInterface</span><span class="p">;</span>

<span class="cd">/**
 * Class RefundInvoice
 * @SuppressWarnings(PHPMD.CouplingBetweenObjects)
 */</span>
<span class="kd">class</span> <span class="nc">RefundInvoice</span> <span class="kd">implements</span> <span class="nc">RefundInvoiceInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var ResourceConnection
     */</span>
    <span class="k">private</span> <span class="nv">$resourceConnection</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderStateResolverInterface
     */</span>
    <span class="k">private</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderRepositoryInterface
     */</span>
    <span class="k">private</span> <span class="nv">$orderRepository</span><span class="p">;</span>

    <span class="cd">/**
     * @var InvoiceRepositoryInterface
     */</span>
    <span class="k">private</span> <span class="nv">$invoiceRepository</span><span class="p">;</span>

    <span class="cd">/**
     * @var CreditmemoRepositoryInterface
     */</span>
    <span class="k">private</span> <span class="nv">$creditmemoRepository</span><span class="p">;</span>

    <span class="cd">/**
     * @var RefundAdapterInterface
     */</span>
    <span class="k">private</span> <span class="nv">$refundAdapter</span><span class="p">;</span>

    <span class="cd">/**
     * @var CreditmemoDocumentFactory
     */</span>
    <span class="k">private</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">;</span>

    <span class="cd">/**
     * @var NotifierInterface
     */</span>
    <span class="k">private</span> <span class="nv">$notifier</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderConfig
     */</span>
    <span class="k">private</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="cd">/**
     * @var LoggerInterface
     */</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="cd">/**
     * @var RefundInvoiceValidator
     */</span>
    <span class="k">private</span> <span class="nv">$validator</span><span class="p">;</span>

    <span class="cd">/**
     * RefundInvoice constructor.
     *
     * @param ResourceConnection $resourceConnection
     * @param OrderStateResolverInterface $orderStateResolver
     * @param OrderRepositoryInterface $orderRepository
     * @param InvoiceRepositoryInterface $invoiceRepository
     * @param RefundInvoiceValidator $validator
     * @param CreditmemoRepositoryInterface $creditmemoRepository
     * @param RefundAdapterInterface $refundAdapter
     * @param CreditmemoDocumentFactory $creditmemoDocumentFactory
     * @param NotifierInterface $notifier
     * @param OrderConfig $config
     * @param LoggerInterface $logger
     * @SuppressWarnings(PHPMD.ExcessiveParameterList)
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">ResourceConnection</span> <span class="nv">$resourceConnection</span><span class="p">,</span>
        <span class="kt">OrderStateResolverInterface</span> <span class="nv">$orderStateResolver</span><span class="p">,</span>
        <span class="kt">OrderRepositoryInterface</span> <span class="nv">$orderRepository</span><span class="p">,</span>
        <span class="kt">InvoiceRepositoryInterface</span> <span class="nv">$invoiceRepository</span><span class="p">,</span>
        <span class="kt">RefundInvoiceValidator</span> <span class="nv">$validator</span><span class="p">,</span>
        <span class="kt">CreditmemoRepositoryInterface</span> <span class="nv">$creditmemoRepository</span><span class="p">,</span>
        <span class="kt">RefundAdapterInterface</span> <span class="nv">$refundAdapter</span><span class="p">,</span>
        <span class="kt">CreditmemoDocumentFactory</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">,</span>
        <span class="kt">NotifierInterface</span> <span class="nv">$notifier</span><span class="p">,</span>
        <span class="kt">OrderConfig</span> <span class="nv">$config</span><span class="p">,</span>
        <span class="kt">LoggerInterface</span> <span class="nv">$logger</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resourceConnection</span> <span class="o">=</span> <span class="nv">$resourceConnection</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderStateResolver</span> <span class="o">=</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span> <span class="o">=</span> <span class="nv">$orderRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">invoiceRepository</span> <span class="o">=</span> <span class="nv">$invoiceRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">validator</span> <span class="o">=</span> <span class="nv">$validator</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">creditmemoRepository</span> <span class="o">=</span> <span class="nv">$creditmemoRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">refundAdapter</span> <span class="o">=</span> <span class="nv">$refundAdapter</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">creditmemoDocumentFactory</span> <span class="o">=</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notifier</span> <span class="o">=</span> <span class="nv">$notifier</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @inheritdoc
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">execute</span><span class="p">(</span>
        <span class="nv">$invoiceId</span><span class="p">,</span>
        <span class="kt">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$isOnline</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resourceConnection</span><span class="o">-&gt;</span><span class="nf">getConnection</span><span class="p">(</span><span class="s1">'sales'</span><span class="p">);</span>
        <span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">invoiceRepository</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$invoiceId</span><span class="p">);</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$invoice</span><span class="o">-&gt;</span><span class="nf">getOrderId</span><span class="p">());</span>
        <span class="nv">$creditmemo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">creditmemoDocumentFactory</span><span class="o">-&gt;</span><span class="nf">createFromInvoice</span><span class="p">(</span>
            <span class="nv">$invoice</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="p">(</span><span class="nv">$appendComment</span> <span class="o">&amp;&amp;</span> <span class="nv">$notify</span><span class="p">),</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>

        <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">validator</span><span class="o">-&gt;</span><span class="nf">validate</span><span class="p">(</span>
            <span class="nv">$invoice</span><span class="p">,</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$creditmemo</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$isOnline</span><span class="p">,</span>
            <span class="nv">$notify</span><span class="p">,</span>
            <span class="nv">$appendComment</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="nf">hasMessages</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Magento\Sales\Exception\DocumentValidationException</span><span class="p">(</span>
                <span class="nf">__</span><span class="p">(</span><span class="s2">"Creditmemo Document Validation Error(s):</span><span class="se">\n</span><span class="s2">"</span> <span class="mf">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="nf">getMessages</span><span class="p">()))</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="nf">setState</span><span class="p">(</span><span class="err">\</span><span class="nc">Magento\Sales\Model\Order\Creditmemo</span><span class="o">::</span><span class="no">STATE_REFUNDED</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setCustomerNoteNotify</span><span class="p">(</span><span class="nv">$notify</span><span class="p">);</span>
            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">refundAdapter</span><span class="o">-&gt;</span><span class="nf">refund</span><span class="p">(</span><span class="nv">$creditmemo</span><span class="p">,</span> <span class="nv">$order</span><span class="p">,</span> <span class="nv">$isOnline</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setState</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderStateResolver</span><span class="o">-&gt;</span><span class="nf">getStateForOrder</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setStatus</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="nf">getStateDefaultStatus</span><span class="p">(</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">getState</span><span class="p">()));</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$isOnline</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="nf">setIsUsedForRefund</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
                <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="nf">setBaseTotalRefunded</span><span class="p">(</span>
                    <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="nf">getBaseTotalRefunded</span><span class="p">()</span> <span class="o">+</span> <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="nf">getBaseGrandTotal</span><span class="p">()</span>
                <span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">invoiceRepository</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$invoice</span><span class="p">);</span>
            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$creditmemo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">creditmemoRepository</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$creditmemo</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="err">\</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span><span class="o">-&gt;</span><span class="nf">critical</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Magento\Sales\Exception\CouldNotRefundException</span><span class="p">(</span>
                <span class="nf">__</span><span class="p">(</span><span class="s1">'Could not save a Creditmemo, see error log for details'</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$notify</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$appendComment</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="o">-&gt;</span><span class="nf">notify</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$creditmemo</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="nf">getEntityId</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
</div>
  </div>

<h4 id="exceptions-1">Exceptions</h4>

<p>In case of failure, it returns an error object. Example in REST:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Creditmemo Document Validation Error(s):</span><span class="se">\n</span><span class="s2">We can't create creditmemo for the order.</span><span class="se">\n</span><span class="s2">The most money available to refund is 0."</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="extension-points-1">Extension points</h4>

<p>The service contains extension points marked with <code class="highlighter-rouge">@api</code> annotation. Extension developers can use APIs to extend service logic.</p>

<table>
  <thead>
    <tr>
      <th>Extension point</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/OrderRepositoryInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Api\OrderRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Orders.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/OrderStateResolverInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\OrderStateResolverInterface</code></a></td>
      <td>An interface providing a correct state of an Order according to performed operation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/InvoiceRepositoryInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Api\InvoiceRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Invoices.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/CreditmemoRepositoryInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Api\CreditmemoRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Credit Memos.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/CreditmemoDocumentFactory.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\CreditmemoDocumentFactory</code></a></td>
      <td>A factory for creating an Credit Memo data object. The factory uses the <code class="highlighter-rouge">arguments</code> parameter to process the extension attributes of a new Credit Memo.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Shipment/NotifierInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\Creditmemo\NotifierInterface</code></a></td>
      <td>An interface for sending notifications about new Credit Memo creation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Validation/RefundInvoiceInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\Validation\RefundInvoiceInterface</code></a></td>
      <td>An interface for validating service parameters and Credit Memo data object.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/RefundAdapterInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\RefundAdapterInterface</code></a></td>
      <td>An interface for a payment according to a selected option (online/offline). It returns Order with modified state, which contains payment specific information.</td>
    </tr>
  </tbody>
</table>

<h2 id="refundorder">RefundOrder</h2>

<p>With the RefundOrder service you can:</p>

<ul>
  <li>create a Credit Memo (complete or partial) for a particular Order</li>
  <li>add details about refunded items to an Order</li>
  <li>change status and state of an Order according to performed actions</li>
  <li>notify a customer about performed refund operation</li>
</ul>

<h3 id="service-parameters-1">Service parameters</h3>

<table>
<thead>
  <tr>
    <th>
      Name
    </th>
    <th>
      Description
    </th>
    <th>
      Format
    </th>
    <th>
      Example
    </th>
    <th>
      Required/Optional
    </th>
    <th>
      Default value
    </th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>
      <code>orderId</code>
    </td>
    <td>
      An identifier of a target Order for operation.
    </td>
    <td>
      Integer
    </td>
    <td>
      &nbsp;
    </td>
    <td>
      Required
    </td>
    <td>
      &nbsp;
    </td>
  </tr>
  <tr>
    <td>
      <code>items</code>
    </td>
    <td>
      An array of Order items included to a Credit Memo. By
      default, the service will create a Credit Memo for all
      Order items.
    </td>
    <td>
      Array of items with a format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoItemCreationInterface.php">
      <code>\Magento\Sales\Api\Data\CreditmemoItemCreationInterface</code></a>.
</td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
        </span><span class="nl">"order_item_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"qty"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
        </span><span class="nl">"order_item_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"qty"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td>
  Optional (required, when a Credit Memo must contain
  particular order items)
</td>
<td>
  <code>[]</code>
</td>
</tr>
<tr>
<td>
  <code>notify</code>
</td>
<td>
  Flag that activates e-mail notification about Credit Memo
  creation. If <code>true</code>, the service notifies a
customer; if <code>false</code>, it doesn't.
</td>
<td>
  Boolean
</td>
<td>
  &nbsp;
</td>
<td>
  Optional
</td>
<td>
  <code>false</code>
</td>
</tr>
<tr>
<td>
  <code>appendComment</code>
</td>
<td>
  Flag that activates addition of a <code>comment</code>
  argument to the e-mail notification. If <code>true</code>
  and <code>comment</code> contains data, the service will
  add the comment to an e-mail notification.
</td>
<td>
  Boolean
</td>
<td>
  &nbsp;
</td>
<td>
  Optional
</td>
<td>
  <code>false</code>
</td>
</tr>
<tr>
<td>
  <code>comment</code>
</td>
<td>
  A comment to Credit Memo.
</td>
<td>
  A format according to the <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCommentCreationInterface.php">
  <code>\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</code></a>.
</td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"comment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The first Credit Memo"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"is_visible_on_front"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td>
Optional
</td>
<td>
<code>null</code>
</td>
</tr>
<tr>
<td>
<code>arguments</code>
</td>
<td>
Additional arguments for the service. Can be used by
extension modules.
</td>
<td>
A format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCreationArgumentsInterface.php">
<code>\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</code></a>.
</td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
</span><span class="nl">"shipping_amount"</span><span class="p">:</span><span class="w"> </span><span class="mf">10.00</span><span class="p">,</span><span class="w">
</span><span class="nl">"adjustment_positive"</span><span class="p">:</span><span class="w"> </span><span class="mf">5.00</span><span class="p">,</span><span class="w">
</span><span class="nl">"adjustment_negative"</span><span class="p">:</span><span class="w"> </span><span class="mf">5.00</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

        <p>A parameter <code class="highlighter-rouge">shipping_amount</code> behaves like at the Credit Memo creation page in the Admin area. If shipping amount is not specified, then shipping amount from a target Invoice is refunded automatically. To specify a shipping amount, consider shipping tax displays settings.</p>
      </td>
<td>
  Optional
</td>
<td>
  <code>null</code>
</td>
</tr>
</tbody>
</table>

<h3 id="return-values-2">Return values</h3>

<p>The service returns an identifier of a created Credit Memo.</p>

<h3 id="rest-2">REST</h3>

<h4 id="post-endpoint-2">POST Endpoint</h4>

<p><code class="highlighter-rouge">http://&lt;magento_host&gt;/rest/&lt;store_code&gt;/V1/&lt;orderId&gt;/refund</code></p>

<h4 id="rest-declaration-2">REST Declaration</h4>

<p><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/etc/webapi.xml"><code class="highlighter-rouge">etc/webapi.xml</code></a></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;route</span> <span class="na">url=</span><span class="s">"/V1/order/:orderId/refund"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">class=</span><span class="s">"Magento\Sales\Api\RefundOrderInterface"</span> <span class="na">method=</span><span class="s">"execute"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;resources&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">ref=</span><span class="s">"Magento_Sales::sales"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resources&gt;</span>
<span class="nt">&lt;/route&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="soap-2">SOAP</h3>

<h4 id="soap-endpoint-2">SOAP Endpoint</h4>

<p><code class="highlighter-rouge">http://&lt;magento_host&gt;/soap/&lt;store_code&gt;?wsdl&amp;services=salesRefundOrderV1</code></p>

<h3 id="php-interface-2">PHP interface</h3>

<p><code class="highlighter-rouge">\Magento\Sales\Api\RefundOrderInterface</code></p>

<div class="collapsible">
    <b class="collapsible-title">Click to show/hide a code </b>
    <div class="collapsible-content"><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cd">/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */</span>
<span class="kn">namespace</span> <span class="nn">Magento\Sales\Api</span><span class="p">;</span>

<span class="cd">/**
 * Interface RefundOrderInterface
 */</span>
<span class="kd">interface</span> <span class="nc">RefundOrderInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * Create offline refund for order
     *
     * @param int $orderId
     * @param \Magento\Sales\Api\Data\CreditmemoItemCreationInterface[] $items
     * @param bool|null $notify
     * @param bool|null $appendComment
     * @param \Magento\Sales\Api\Data\CreditmemoCommentCreationInterface|null $comment
     * @param \Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface|null $arguments
     * @return int
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="kt">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">);</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
</div>
  </div>

<h3 id="php-implementation-2">PHP implementation</h3>

<p><code class="highlighter-rouge">\Magento\Sales\Model\RefundOrder</code></p>

<div class="collapsible">
    <b class="collapsible-title">Click to show/hide a code </b>
    <div class="collapsible-content"><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cd">/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */</span>
<span class="kn">namespace</span> <span class="nn">Magento\Sales\Model</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Magento\Framework\App\ResourceConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\CreditmemoRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\OrderRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\RefundOrderInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Config</span> <span class="k">as</span> <span class="nc">OrderConfig</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Creditmemo\NotifierInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\CreditmemoDocumentFactory</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\OrderStateResolverInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\RefundAdapterInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Validation\RefundOrderInterface</span> <span class="k">as</span> <span class="nc">RefundOrderValidator</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Psr\Log\LoggerInterface</span><span class="p">;</span>

<span class="cd">/**
 * Class RefundOrder
 * @SuppressWarnings(PHPMD.CouplingBetweenObjects)
 */</span>
<span class="kd">class</span> <span class="nc">RefundOrder</span> <span class="kd">implements</span> <span class="nc">RefundOrderInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var ResourceConnection
     */</span>
    <span class="k">private</span> <span class="nv">$resourceConnection</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderStateResolverInterface
     */</span>
    <span class="k">private</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderRepositoryInterface
     */</span>
    <span class="k">private</span> <span class="nv">$orderRepository</span><span class="p">;</span>

    <span class="cd">/**
     * @var CreditmemoRepositoryInterface
     */</span>
    <span class="k">private</span> <span class="nv">$creditmemoRepository</span><span class="p">;</span>

    <span class="cd">/**
     * @var RefundAdapterInterface
     */</span>
    <span class="k">private</span> <span class="nv">$refundAdapter</span><span class="p">;</span>

    <span class="cd">/**
     * @var CreditmemoDocumentFactory
     */</span>
    <span class="k">private</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">;</span>

    <span class="cd">/**
     * @var RefundOrderValidator
     */</span>
    <span class="k">private</span> <span class="nv">$validator</span><span class="p">;</span>

    <span class="cd">/**
     * @var NotifierInterface
     */</span>
    <span class="k">private</span> <span class="nv">$notifier</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderConfig
     */</span>
    <span class="k">private</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="cd">/**
     * @var LoggerInterface
     */</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="cd">/**
     * RefundOrder constructor.
     *
     * @param ResourceConnection $resourceConnection
     * @param OrderStateResolverInterface $orderStateResolver
     * @param OrderRepositoryInterface $orderRepository
     * @param CreditmemoRepositoryInterface $creditmemoRepository
     * @param RefundAdapterInterface $refundAdapter
     * @param CreditmemoDocumentFactory $creditmemoDocumentFactory
     * @param RefundOrderValidator $validator
     * @param NotifierInterface $notifier
     * @param OrderConfig $config
     * @param LoggerInterface $logger
     * @SuppressWarnings(PHPMD.ExcessiveParameterList)
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">ResourceConnection</span> <span class="nv">$resourceConnection</span><span class="p">,</span>
        <span class="kt">OrderStateResolverInterface</span> <span class="nv">$orderStateResolver</span><span class="p">,</span>
        <span class="kt">OrderRepositoryInterface</span> <span class="nv">$orderRepository</span><span class="p">,</span>
        <span class="kt">CreditmemoRepositoryInterface</span> <span class="nv">$creditmemoRepository</span><span class="p">,</span>
        <span class="kt">RefundAdapterInterface</span> <span class="nv">$refundAdapter</span><span class="p">,</span>
        <span class="kt">CreditmemoDocumentFactory</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">,</span>
        <span class="kt">RefundOrderValidator</span> <span class="nv">$validator</span><span class="p">,</span>
        <span class="kt">NotifierInterface</span> <span class="nv">$notifier</span><span class="p">,</span>
        <span class="kt">OrderConfig</span> <span class="nv">$config</span><span class="p">,</span>
        <span class="kt">LoggerInterface</span> <span class="nv">$logger</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resourceConnection</span> <span class="o">=</span> <span class="nv">$resourceConnection</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderStateResolver</span> <span class="o">=</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span> <span class="o">=</span> <span class="nv">$orderRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">creditmemoRepository</span> <span class="o">=</span> <span class="nv">$creditmemoRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">refundAdapter</span> <span class="o">=</span> <span class="nv">$refundAdapter</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">creditmemoDocumentFactory</span> <span class="o">=</span> <span class="nv">$creditmemoDocumentFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">validator</span> <span class="o">=</span> <span class="nv">$validator</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notifier</span> <span class="o">=</span> <span class="nv">$notifier</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @inheritdoc
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="kt">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resourceConnection</span><span class="o">-&gt;</span><span class="nf">getConnection</span><span class="p">(</span><span class="s1">'sales'</span><span class="p">);</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$orderId</span><span class="p">);</span>
        <span class="nv">$creditmemo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">creditmemoDocumentFactory</span><span class="o">-&gt;</span><span class="nf">createFromOrder</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="p">(</span><span class="nv">$appendComment</span> <span class="o">&amp;&amp;</span> <span class="nv">$notify</span><span class="p">),</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">validator</span><span class="o">-&gt;</span><span class="nf">validate</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$creditmemo</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$notify</span><span class="p">,</span>
            <span class="nv">$appendComment</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="nf">hasMessages</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Magento\Sales\Exception\DocumentValidationException</span><span class="p">(</span>
                <span class="nf">__</span><span class="p">(</span><span class="s2">"Creditmemo Document Validation Error(s):</span><span class="se">\n</span><span class="s2">"</span> <span class="mf">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="nf">getMessages</span><span class="p">()))</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="nf">setState</span><span class="p">(</span><span class="err">\</span><span class="nc">Magento\Sales\Model\Order\Creditmemo</span><span class="o">::</span><span class="no">STATE_REFUNDED</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setCustomerNoteNotify</span><span class="p">(</span><span class="nv">$notify</span><span class="p">);</span>
            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">refundAdapter</span><span class="o">-&gt;</span><span class="nf">refund</span><span class="p">(</span><span class="nv">$creditmemo</span><span class="p">,</span> <span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setState</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderStateResolver</span><span class="o">-&gt;</span><span class="nf">getStateForOrder</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="p">[])</span>
            <span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setStatus</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="nf">getStateDefaultStatus</span><span class="p">(</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">getState</span><span class="p">()));</span>

            <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$creditmemo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">creditmemoRepository</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$creditmemo</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="err">\</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span><span class="o">-&gt;</span><span class="nf">critical</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Magento\Sales\Exception\CouldNotRefundException</span><span class="p">(</span>
                <span class="nf">__</span><span class="p">(</span><span class="s1">'Could not save a Creditmemo, see error log for details'</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$notify</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$appendComment</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notifier</span><span class="o">-&gt;</span><span class="nf">notify</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$creditmemo</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$creditmemo</span><span class="o">-&gt;</span><span class="nf">getEntityId</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
</div>
  </div>

<h4 id="exceptions-2">Exceptions</h4>

<p>In case of failure, it returns an error object. Example in REST:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Creditmemo Document Validation Error(s):</span><span class="se">\n</span><span class="s2">We can't create creditmemo for the order.</span><span class="se">\n</span><span class="s2">The most money available to refund is 0."</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="extension-points-2">Extension points</h4>

<p>The service contains extension points marked with <code class="highlighter-rouge">@api</code> annotation. Extension developers can use APIs to extend service logic.</p>

<table>
  <thead>
    <tr>
      <th>Extension point</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/OrderRepositoryInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Api\OrderRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Orders.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/OrderStateResolverInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\OrderStateResolverInterface</code></a></td>
      <td>An interface providing a correct state of an Order according to performed operation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/CreditmemoRepositoryInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Api\CreditmemoRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Credit Memos.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/CreditmemoDocumentFactory.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\CreditmemoDocumentFactory</code></a></td>
      <td>A factory for creating an Credit Memo data object. The factory uses the <code class="highlighter-rouge">arguments</code> parameter to process the extension attributes of a new Credit Memo.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Shipment/NotifierInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\Creditmemo\NotifierInterface</code></a></td>
      <td>An interface for sending notifications about new Credit Memo creation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Validation/RefundOrderInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\Validation\RefundOrderInterface</code></a></td>
      <td>An interface for validating service parameters and Credit Memo data object.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/RefundAdapterInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\RefundAdapterInterface</code></a></td>
      <td>An interface for a payment according to a selected option (online/offline). It returns Order with modified state, which contains payment specific information.</td>
    </tr>
  </tbody>
</table>

<h2 id="shiporder">ShipOrder</h2>

<p>With the ShipOrder service you can:</p>

<ul>
  <li>create a <a href="https://glossary.magento.com/shipment">shipment</a> document (full or partial)</li>
  <li>add details about shipped items into an order</li>
  <li>change status and state of an order according to performed actions</li>
  <li>notify the customer of a new <a href="https://glossary.magento.com/shipment-document">shipment document</a></li>
</ul>

<h3 id="service-parameters-2">Service parameters</h3>

<table>
<thead>
<tr>
  <th>Name</th>
  <th>Description</th>
  <th>Format</th>
  <th>Example</th>
  <th>Required/Optional</th>
  <th>Default value</th>
</tr>
</thead>
<tbody>
<tr>
  <td><code>orderId</code></td>
  <td>An identifier of a target order for operation.</td>
  <td>Integer</td>
  <td>&nbsp;</td>
  <td>Required</td>
  <td>&nbsp;</td>
</tr>
<tr>
  <td><code>items</code></td>
  <td>An array of order items included to a shipment. By default, the service will create a shipment for all order items.</td>
  <td>Array of items with a format according to <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/ShipmentItemCreationInterface.php"><code>\Magento\Sales\Api\Data\ShipmentItemCreationInterface</code></a>.</td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"order_item_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"qty"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"order_item_id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"qty"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td>Optional (required, when a shipment document must contain particular order items)</td>
<td><code>[]</code></td>
</tr>
<tr>
<td><code>notify</code></td>
<td>Flag that activates e-mail notification about shipment details. If <code>true</code>, the service notifies a customer; if <code>false</code>, it doesn't.</td>
<td>Boolean</td>
<td>&nbsp;</td>
<td>Optional</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>appendComment</code></td>
<td>Flag that activates addition of a <code>comment</code> argument to the e-mail notification. If <code>true</code> and <code>comment</code> contains data, the service will add the comment to an e-mail notification.</td>
<td>Boolean</td>
<td>&nbsp;</td>
<td>Optional</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>comment</code></td>
<td>A comment about a shipment.</td>
<td>A format according to the
  <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCommentCreationInterface.php"><code>\Magento\Sales\Api\Data\CreditmemoCommentCreationInterface</code></a>
  interface.</td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"comment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The first Invoice"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"is_visible_on_front"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td> Optional </td>
<td> <code>null</code> </td>
</tr>
<tr>
<td> <code>tracks</code> </td>
<td> A list of track numbers attached to a shipment. </td>
<td> Array of objects with a format according to
  <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/ShipmentTrackCreationInterface.php"><code>\Magento\Sales\Api\Data\ShipmentTrackCreationInterface&gt;</code></a>. </td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"track_number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"132456789"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"United States Postal Service"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"carrier_code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"usps"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td> Optional </td>
<td> <code>[]</code> </td>
</tr>
<tr>
<td> <code>packages</code> </td>
<td> A list of packages attached to a shipment. </td>
<td> Array of objects with a format according to
  <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/ShipmentPackageCreationInterface.php"><code>\Magento\Sales\Api\Data\ShipmentPackageCreationInterface</code></a>. </td>
<td>

        <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="p">[</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"extension_attributes"</span><span class="p">:</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"ups"</span><span class="p">:</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"weight"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w">
        </span><span class="nl">"height"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w">
        </span><span class="nl">"width"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>        </div>

      </td>
<td>Optional</td>
<td><code>[]</code></td>
</tr>
<tr>
<td><code>arguments</code></td>
<td>Additional arguments for the service. Can be used by
  extension modules.</td>
<td>A format according to the
  <a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/Data/CreditmemoCreationArgumentsInterface.php"><code>\Magento\Sales\Api\Data\CreditmemoCreationArgumentsInterface</code></a>
  interface.</td>
<td>&nbsp;</td>
<td>Optional</td>
<td><code>null</code></td>
</tr>
</tbody>
</table>

<h3 id="return-values-3">Return values</h3>

<p>The service returns the identifier of a created shipment.</p>

<h3 id="rest-3">REST</h3>

<h4 id="post-endpoint-3">POST Endpoint</h4>

<p><code class="highlighter-rouge">http://&lt;magento_host&gt;/rest/&lt;store_code&gt;/V1/&lt;orderId&gt;/ship</code></p>

<h4 id="rest-declaration-3">REST Declaration</h4>

<p><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/etc/webapi.xml"><code class="highlighter-rouge">etc/webapi.xml</code></a></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;route</span> <span class="na">url=</span><span class="s">"/V1/order/:orderId/ship"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;service</span> <span class="na">class=</span><span class="s">"Magento\Sales\Api\ShipOrderInterface"</span> <span class="na">method=</span><span class="s">"execute"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;resources&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">ref=</span><span class="s">"Magento_Sales::sales"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resources&gt;</span>
<span class="nt">&lt;/route&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="soap-3">SOAP</h3>

<h4 id="soap-endpoint-3">SOAP Endpoint</h4>

<p><code class="highlighter-rouge">http://&lt;magento_host&gt;/soap/&lt;store_code&gt;?wsdl&amp;services=salesShipOrderV1</code></p>

<h3 id="php-interface-3">PHP interface</h3>

<p><code class="highlighter-rouge">\Magento\Sales\Api\ShipOrderInterface</code></p>

<div class="collapsible">
    <b class="collapsible-title">Click to show/hide a code </b>
    <div class="collapsible-content"><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cd">/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */</span>
<span class="kn">namespace</span> <span class="nn">Magento\Sales\Api</span><span class="p">;</span>

<span class="cd">/**
 * Class ShipOrderInterface
 *
 * @api
 */</span>
<span class="kd">interface</span> <span class="nc">ShipOrderInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * Creates new Shipment for given Order.
     *
     * @param int $orderId
     * @param \Magento\Sales\Api\Data\ShipmentItemCreationInterface[] $items
     * @param bool $notify
     * @param bool $appendComment
     * @param \Magento\Sales\Api\Data\ShipmentCommentCreationInterface|null $comment
     * @param \Magento\Sales\Api\Data\ShipmentTrackCreationInterface[] $tracks
     * @param \Magento\Sales\Api\Data\ShipmentPackageCreationInterface[] $packages
     * @param \Magento\Sales\Api\Data\ShipmentCreationArgumentsInterface|null $arguments
     * @return int Id of created Shipment.
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="kt">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\ShipmentCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$tracks</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="k">array</span> <span class="nv">$packages</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\ShipmentCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">);</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
</div>
  </div>

<h3 id="php-implementation-3">PHP implementation</h3>

<p><code class="highlighter-rouge">\Magento\Sales\Model\ShipOrder</code></p>

<div class="collapsible">
    <b class="collapsible-title">Click to show/hide a code </b>
    <div class="collapsible-content"><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="cd">/**
 * Copyright © Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */</span>
<span class="kn">namespace</span> <span class="nn">Magento\Sales\Model</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Magento\Framework\App\ResourceConnection</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\OrderRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\ShipmentRepositoryInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Api\ShipOrderInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Config</span> <span class="k">as</span> <span class="nc">OrderConfig</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\OrderStateResolverInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\OrderValidatorInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\ShipmentDocumentFactory</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Shipment\NotifierInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Shipment\ShipmentValidatorInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Shipment\OrderRegistrarInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Sales\Model\Order\Validation\ShipOrderInterface</span> <span class="k">as</span> <span class="nc">ShipOrderValidator</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Psr\Log\LoggerInterface</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Magento\Framework\App\ObjectManager</span><span class="p">;</span>

<span class="cd">/**
 * Class ShipOrder
 * @SuppressWarnings(PHPMD.CouplingBetweenObjects)
 */</span>
<span class="kd">class</span> <span class="nc">ShipOrder</span> <span class="kd">implements</span> <span class="nc">ShipOrderInterface</span>
<span class="p">{</span>
    <span class="cd">/**
     * @var ResourceConnection
     */</span>
    <span class="k">private</span> <span class="nv">$resourceConnection</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderRepositoryInterface
     */</span>
    <span class="k">private</span> <span class="nv">$orderRepository</span><span class="p">;</span>

    <span class="cd">/**
     * @var ShipmentDocumentFactory
     */</span>
    <span class="k">private</span> <span class="nv">$shipmentDocumentFactory</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderStateResolverInterface
     */</span>
    <span class="k">private</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderConfig
     */</span>
    <span class="k">private</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="cd">/**
     * @var ShipmentRepositoryInterface
     */</span>
    <span class="k">private</span> <span class="nv">$shipmentRepository</span><span class="p">;</span>

    <span class="cd">/**
     * @var ShipOrderValidator
     */</span>
    <span class="k">private</span> <span class="nv">$shipOrderValidator</span><span class="p">;</span>

    <span class="cd">/**
     * @var NotifierInterface
     */</span>
    <span class="k">private</span> <span class="nv">$notifierInterface</span><span class="p">;</span>

    <span class="cd">/**
     * @var LoggerInterface
     */</span>
    <span class="k">private</span> <span class="nv">$logger</span><span class="p">;</span>

    <span class="cd">/**
     * @var OrderRegistrarInterface
     */</span>
    <span class="k">private</span> <span class="nv">$orderRegistrar</span><span class="p">;</span>

    <span class="cd">/**
     * @param ResourceConnection $resourceConnection
     * @param OrderRepositoryInterface $orderRepository
     * @param ShipmentDocumentFactory $shipmentDocumentFactory
     * @param ShipmentValidatorInterface $shipmentValidator
     * @param OrderValidatorInterface $orderValidator
     * @param OrderStateResolverInterface $orderStateResolver
     * @param OrderConfig $config
     * @param ShipmentRepositoryInterface $shipmentRepository
     * @param NotifierInterface $notifierInterface
     * @param OrderRegistrarInterface $orderRegistrar
     * @param LoggerInterface $logger
     * @param ShipOrderValidator|null $shipOrderValidator
     * @SuppressWarnings(PHPMD.ExcessiveParameterList)
     * @SuppressWarnings(PHPMD.UnusedFormalParameter)
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span>
        <span class="kt">ResourceConnection</span> <span class="nv">$resourceConnection</span><span class="p">,</span>
        <span class="kt">OrderRepositoryInterface</span> <span class="nv">$orderRepository</span><span class="p">,</span>
        <span class="kt">ShipmentDocumentFactory</span> <span class="nv">$shipmentDocumentFactory</span><span class="p">,</span>
        <span class="kt">ShipmentValidatorInterface</span> <span class="nv">$shipmentValidator</span><span class="p">,</span>
        <span class="kt">OrderValidatorInterface</span> <span class="nv">$orderValidator</span><span class="p">,</span>
        <span class="kt">OrderStateResolverInterface</span> <span class="nv">$orderStateResolver</span><span class="p">,</span>
        <span class="kt">OrderConfig</span> <span class="nv">$config</span><span class="p">,</span>
        <span class="kt">ShipmentRepositoryInterface</span> <span class="nv">$shipmentRepository</span><span class="p">,</span>
        <span class="kt">NotifierInterface</span> <span class="nv">$notifierInterface</span><span class="p">,</span>
        <span class="kt">OrderRegistrarInterface</span> <span class="nv">$orderRegistrar</span><span class="p">,</span>
        <span class="kt">LoggerInterface</span> <span class="nv">$logger</span><span class="p">,</span>
        <span class="kt">ShipOrderValidator</span> <span class="nv">$shipOrderValidator</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resourceConnection</span> <span class="o">=</span> <span class="nv">$resourceConnection</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span> <span class="o">=</span> <span class="nv">$orderRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">shipmentDocumentFactory</span> <span class="o">=</span> <span class="nv">$shipmentDocumentFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderStateResolver</span> <span class="o">=</span> <span class="nv">$orderStateResolver</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">shipmentRepository</span> <span class="o">=</span> <span class="nv">$shipmentRepository</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notifierInterface</span> <span class="o">=</span> <span class="nv">$notifierInterface</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span> <span class="o">=</span> <span class="nv">$logger</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRegistrar</span> <span class="o">=</span> <span class="nv">$orderRegistrar</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">shipOrderValidator</span> <span class="o">=</span> <span class="nv">$shipOrderValidator</span> <span class="o">?:</span> <span class="nc">ObjectManager</span><span class="o">::</span><span class="nf">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span>
            <span class="nc">ShipOrderValidator</span><span class="o">::</span><span class="n">class</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="cd">/**
     * @param int $orderId
     * @param \Magento\Sales\Api\Data\ShipmentItemCreationInterface[] $items
     * @param bool $notify
     * @param bool $appendComment
     * @param \Magento\Sales\Api\Data\ShipmentCommentCreationInterface|null $comment
     * @param \Magento\Sales\Api\Data\ShipmentTrackCreationInterface[] $tracks
     * @param \Magento\Sales\Api\Data\ShipmentPackageCreationInterface[] $packages
     * @param \Magento\Sales\Api\Data\ShipmentCreationArgumentsInterface|null $arguments
     * @return int
     * @throws \Magento\Sales\Api\Exception\DocumentValidationExceptionInterface
     * @throws \Magento\Sales\Api\Exception\CouldNotShipExceptionInterface
     * @throws \Magento\Framework\Exception\InputException
     * @throws \Magento\Framework\Exception\NoSuchEntityException
     * @throws \DomainException
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">execute</span><span class="p">(</span>
        <span class="nv">$orderId</span><span class="p">,</span>
        <span class="kt">array</span> <span class="nv">$items</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nv">$notify</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nv">$appendComment</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\ShipmentCommentCreationInterface</span> <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="k">array</span> <span class="nv">$tracks</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="k">array</span> <span class="nv">$packages</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="err">\</span><span class="nc">Magento\Sales\Api\Data\ShipmentCreationArgumentsInterface</span> <span class="nv">$arguments</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">resourceConnection</span><span class="o">-&gt;</span><span class="nf">getConnection</span><span class="p">(</span><span class="s1">'sales'</span><span class="p">);</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$orderId</span><span class="p">);</span>
        <span class="nv">$shipment</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">shipmentDocumentFactory</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$tracks</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="p">(</span><span class="nv">$appendComment</span> <span class="o">&amp;&amp;</span> <span class="nv">$notify</span><span class="p">),</span>
            <span class="nv">$packages</span><span class="p">,</span>
            <span class="nv">$arguments</span>
        <span class="p">);</span>
        <span class="nv">$validationMessages</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">shipOrderValidator</span><span class="o">-&gt;</span><span class="nf">validate</span><span class="p">(</span>
            <span class="nv">$order</span><span class="p">,</span>
            <span class="nv">$shipment</span><span class="p">,</span>
            <span class="nv">$items</span><span class="p">,</span>
            <span class="nv">$notify</span><span class="p">,</span>
            <span class="nv">$appendComment</span><span class="p">,</span>
            <span class="nv">$comment</span><span class="p">,</span>
            <span class="nv">$tracks</span><span class="p">,</span>
            <span class="nv">$packages</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="nf">hasMessages</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Magento\Sales\Exception\DocumentValidationException</span><span class="p">(</span>
                <span class="nf">__</span><span class="p">(</span><span class="s2">"Shipment Document Validation Error(s):</span><span class="se">\n</span><span class="s2">"</span> <span class="mf">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$validationMessages</span><span class="o">-&gt;</span><span class="nf">getMessages</span><span class="p">()))</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">beginTransaction</span><span class="p">();</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRegistrar</span><span class="o">-&gt;</span><span class="nf">register</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$shipment</span><span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setState</span><span class="p">(</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderStateResolver</span><span class="o">-&gt;</span><span class="nf">getStateForOrder</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="p">[</span><span class="nc">OrderStateResolverInterface</span><span class="o">::</span><span class="no">IN_PROGRESS</span><span class="p">])</span>
            <span class="p">);</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">setStatus</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="nf">getStateDefaultStatus</span><span class="p">(</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="nf">getState</span><span class="p">()));</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">shipmentRepository</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$shipment</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">orderRepository</span><span class="o">-&gt;</span><span class="nf">save</span><span class="p">(</span><span class="nv">$order</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">commit</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="err">\</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">logger</span><span class="o">-&gt;</span><span class="nf">critical</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="nf">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">Magento\Sales\Exception\CouldNotShipException</span><span class="p">(</span>
                <span class="nf">__</span><span class="p">(</span><span class="s1">'Could not save a shipment, see error log for details'</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$notify</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$appendComment</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$comment</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">notifierInterface</span><span class="o">-&gt;</span><span class="nf">notify</span><span class="p">(</span><span class="nv">$order</span><span class="p">,</span> <span class="nv">$shipment</span><span class="p">,</span> <span class="nv">$comment</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$shipment</span><span class="o">-&gt;</span><span class="nf">getEntityId</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
</div>
  </div>

<h4 id="exceptions-3">Exceptions</h4>

<p>In case of failure, it returns an error object. Example in REST:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlighter"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Creditmemo Document Validation Error(s):</span><span class="se">\n</span><span class="s2">We can't create creditmemo for the order.</span><span class="se">\n</span><span class="s2">The most money available to refund is 0."</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="extension-points-3">Extension points</h4>

<p>The service contains extension points marked with <code class="highlighter-rouge">@api</code> annotation. Extension developers can use APIs to extend service logic.</p>

<table>
  <thead>
    <tr>
      <th>Extension point</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/OrderRepositoryInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Api\OrderRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Orders.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/OrderStateResolverInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\OrderStateResolverInterface</code></a></td>
      <td>An interface providing a correct state of an Order according to performed operation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Api/ShipmentRepositoryInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Api\ShipmentRepositoryInterface</code></a></td>
      <td>An interface for saving and retrieving Shipments.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/ShipmentDocumentFactory.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\ShipmentDocumentFactory</code></a></td>
      <td>A factory creating a Shipment data object. The factory uses the <code class="highlighter-rouge">arguments</code> parameter to process the extension attributes of a new shipment document.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Shipment/NotifierInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\Shipment\NotifierInterface</code></a></td>
      <td>An interface for sending notifications about new Shipment creation.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Validation/ShipOrderInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\Validation\ShipOrderInterface</code></a></td>
      <td>An interface for validating the service parameters and created Shipment data object.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/magento/magento2/blob/2.1/app/code/Magento/Sales/Model/Order/Shipment/OrderRegistrarInterface.php" target="_blank"><code class="highlighter-rouge">\Magento\Sales\Model\Order\Shipment\OrderRegistrarInterface</code></a></td>
      <td>An interface for registering a Shipment in Order to update amount of shipped items in a given Order according to Shipment. The <code class="highlighter-rouge">execute</code> method returns an updated Order.</td>
    </tr>
  </tbody>
</table>

<!-- LINK DEFINITIONS -->


			
		</div>
		<!-- /.content-wrap -->

		<div class="page-info">

  
  <div class="page-updated">
    <img src="/devdocs-archive/2.1/i/icons/time.svg" alt="Updated" />
    <time id="last-modified-at" itemprop="dateModified" datetime="2019-05-31">
      May 31st, 2019
    </time>
  </div>
  

  


  

    

    

  

</div>


	</section>
	<!-- /.content -->

</div> <!-- /.content-container -->


	</div>
	<!-- /.main-container -->
</div>
<!-- /#gl-wrapper -->

<!-- footer-->
<div class="page-footer">
  <div class="container">

    <div class="copyright-links">
      

<ul class="nav footer-links" role="menu">

  <li class="" role="menuitem"><a href="https://github.com/magento/devdocs/blob/master/.github/CONTRIBUTING.md">Become a Contributor</a></li>

  <li class="" role="menuitem"><a href="https://glossary.magento.com/">Glossary</a></li>

  <li class="" role="menuitem"><a href="https://magento.com/legal/terms/privacy/">Privacy Policy</a></li>

  <li class="" role="menuitem"><a href="https://magento.com/legal/terms/">Terms of Service</a></li>

  <li class="" role="menuitem"><a href="https://magento.com/legal/licensing/">License/Trademark FAQ</a></li>

  <li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/release-notes/bk-release-notes.html">Release Notes</a></li>

  <li class="" role="menuitem"><a href="/devdocs-archive/2.1/guides/v2.1/release-notes/packages-open-source.html">Third-Party Licenses</a></li>

</ul>

    </div>

		<div class="copyright-date">&copy; 2023 Magento. All rights reserved.</div>

  </div>
</div>
<!-- / #footer -->


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="/devdocs-archive/2.1/assets/js/app.min.js"></script>





<script type="text/javascript" src="/devdocs-archive/2.1/common/js/last-modified-at.js"></script>
<script type="text/javascript" src="/devdocs-archive/2.1/common/js/glossary-link-enhancer.js"></script>


</body>
</html>

